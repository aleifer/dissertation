%!TEX root = /Users/andy/Documents/Academics/Dissertation/thesis.tex
 %!TEX root = /Users/andy/Documents/Academics/Dissertation/thesis.tex

\chapter{Optogenetic manipulation of neural activity in freely moving \textit{Caenorhabditis elegans}}


\section{Introduction}
\lettrine{R}{easerchers in systems neuroscience} aim to understand how neural dynamics create behavior. Optogenetics has accelerated progress in this area by making it possible to stimulate or inhibit neurons that express light-activated proteins, for example, channelrhodopsin-2 (ChR2) and halorhodopsin (also known as Halo/NpHR), by illuminating them \citep{nagel_channelrhodopsin-2_2003, boyden_millisecond-timescale_2005, zhang_channelrhodopsin-2_2006, han_multiple-color_2007,szobota_remote_2007,zhang_multimodal_2007,chow_high-performance_2010}. 
The nematode \textit{C. elegans} is particularly amenable to optogenetics owing to its optical transparency, compact nervous system and ease of genetic manipulation \citep{nagel_light_2005, liewald_optogenetic_2008, guo_optical_2009,stirman_high-throughput_2010}.

The ability to deliver light to one cell with spatial selectivity is essential for targeted optogenetic perturbation in the many cases in \textit{C. elegans} in which genetic methods do not provide adequate specificity. In the worm motor circuit, for example, single neuron-specific promoters are not available to drive expression of light-activated proteins in only one or a few neurons of the ventral nerve cord (VNC).
Optogenetics has been applied to the mechanosensory circuit in \textit{C. elegans}, but only through simultaneous stimulation of all touch receptor neurons, because promoters specific to each neuron are unavailable \citep{nagel_channelrhodopsin-2_2003}. 
Researchers can use laser killing to study the contribution of single touch receptor neurons to overall behavior by removing neurons, but it is often preferable to work with intact circuits \citep{chalfie_neural_1985, wicks_dynamic_1996, kitamura_contribution_2001}.
Recently, a digital micromirror device (DMD) has been used to deliver light with high spatial selectivity in immobilized \textit{C. elegans} and immobilized \textit{Danio rerio} zebrafish \citep{wyart_optogenetic_2009}; each element of a DMD may be independently controlled to deliver light to a corresponding pixel of a microscope's field of view. 
In many cases, however, the normal operation of neural circuits can be studied only in freely behaving animals, requiring a more sophisticated instrument.

Here we describe an optogenetic illumination system that allows perturbations of neural activity with high spatial and temporal resolution in an unrestrained worm, enabling us to \emph{Co}ntrol \emph{L}ocomotion and \emph{Be}havior in \emph{R}eal \emph{T}ime (CoLBeRT) in\textit{C. elegans}. In the CoLBeRT system, a video camera follows a worm under dark-field illumination, and a motorized stage keeps the worm centered in the camera's field of view. Machine-vision algorithms estimate the coordinates of targeted cells within the worm body and generate an illumination pattern that is projected onto the worm by a DMD with laser light, and the cycle repeats itself for the next frame. Because the worm is a moving target, the faster an image can be captured and translated into DMD directives, the more accurately an individual cell can be targeted. The CoLBeRT system carries out all of these functions in \textasciitilde20 ms, providing a spatial resolution of \textasciitilde30 $\mu$m in optogenetic control for freely swimming\textit{C. elegans}. We analyzed the motor circuit and mechanosensory circuit of unrestrained worms, demonstrating the performance of the CoLBeRT system, a new tool that enhances the flexibility and power of optogenetic approaches in \textit{C. elegans}.

\section{Results}
\subsection{Experimental Setup}
To stimulate neurons using ChR2 or inhibit neurons using Halo/NpHR, we used a 473-nm or 532-nm wavelength diode-pumped solid state (DPSS) laser, respectively  (Fig.~\ref{fig:colbert1}a). Either laser was incident onto a DMD with 1,024 × 768 elements. Laser light was reflected onto the specimen only when an individual micromirror was turned to the 'on' position. We illuminated the specimen under dark-field illumination by red light to avoid exciting ChR2 or Halo/NpHR. Filter cubes reflected the wavelengths for optogenetic illumination from the DMD onto the sample, while passing longer wavelengths for dark-field illumination to a camera. A motorized stage kept the specimen in the field of view.



\begin{FPfigure} 
\includegraphics[width=\textwidth]{figures/colbert1}
\caption[CoLBeRT system apparatus and methodology]{High-resolution optogenetic control of freely moving \textit{C. elegans}.  (\textbf{a}) An individual worm swims or crawls on a motorized stage under red dark-field illumination. A high-speed camera images the worm. Custom software instructs a DMD to reflect laser light onto targeted cells. (\textbf{b}) Images are acquired and processed at ~50 FPS. Each 1,024 × 768 pixel image is thresholded and the worm boundary is found. Head and tail are located as maxima of boundary curvature (red arrows). Centerline is calculated from the midpoint of line segments connecting dorsal and ventral boundaries (blue bar) and is resampled to contain 100 equally spaced points. The worm is partitioned into segments by finding vectors (green arrows) from centerline to boundary, and selecting one that is most perpendicular to the centerline (orange arrow). Targets defined in worm coordinates are transformed into image coordinates and sent to the DMD for illumination (green bar). (\textbf{c}) Schematic of body-wall muscles. Anterior, to left; dorsal, to top. Bending wave speed of swimming worm expressing Halo/NpHR in its body-wall muscles subjected to green light (10~mW~mm$^{-2}$) outside or inside the worm boundary (n = 5 worms, representative trace). (\textbf{d}) Schematic of HSN. A swimming worm expressing ChR2 in HSN was subjected to blue light (5~mW~mm$^{-2}$). Histogram, position at which egg-laying occurred when a narrow stripe of light was slowly scanned along the worm's centerline (n = 13 worms). Once an egg was laid, the worm was discarded. \label{fig:colbert1}}
\end{FPfigure}

To accelerate real-time image analysis of worm posture, we developed the MindControl software package using the open-source OpenCV computer vision library\citep{bradski_opencv_2000}. With the graphical user interface (GUI), the user can dynamically target specific regions of freely moving worms. The MindControl software and documentation are available at \href{http://github.com/samuellab/mindcontrol}{http://github.com/samuellab/mindcontrol}.


The MindControl software carries out a sequence of image analysis operations on each frame received from the camera (Fig.~\ref{fig:colbert1}b). An image is captured by the computer, filtered and thresholded. Next, the boundary of the worm is calculated, and head and tail are identified as local maxima of boundary curvature (the head is blunt and the tail is sharp). The worm centerline is calculated and the body is divided into 100 evenly spaced segments. These segments define a worm coordinate system invariant to worm posture or orientation, within which the user may define target positions. The software maps the position of targets onto the coordinates of the real image and finally sends the appropriate pattern to the DMD for illumination.

For our current system, the total latency between image acquisition and DMD illumination is 20~ms: image exposure, 2~ms; data transfer to computer, 3~ms; image analysis, 10~ms; and data transfer to DMD, 5~ms. Given the size and speed of a swimming worm at 10× magnification, our system working at \textasciitilde50 frames per second (FPS) delivers optogenetic illumination with a spatial resolution of \textasciitilde30~$\mu$m, not far from the spatial resolution limit imposed by the pixel density of the DMD (\textasciitilde5~$\mu$m at 10× magnification).

\subsection{Spatial resolution of the illumination system}
First, we confirmed that illumination is restricted to the targeted area. We examined a transgenic worm expressing \textit{Halo/NpHR::CFP} in all body-wall muscles. Whole-animal illumination of transgenic P\textit{myo-$3$::Halo/NpHR} worms causes all muscles to relax \citep{zhang_multimodal_2007}. We placed individual swimming worms in the CoLBeRT system and used green light (532 nm, 10~mW~mm$^{-2}$) to alternately illuminate the entire region outside and inside the worm boundary (Fig.~\ref{fig:colbert1}b and Supplementary Video 1). Illuminating the entire region outside the worm boundary had no effect as bending waves propagated from head to tail at normal speed. Illuminating the entire region inside the worm boundary, however, arrested locomotion as the body relaxed and the speed of bending waves dropped to zero.

To quantify the spatial resolution of the CoLBeRT system, we measured its targeting accuracy in evoking egg-laying events by stimulating the HSN motor neurons. We used transgenic worms expressing ChR2 under the \textit{egl-$6$} promoter, which drives expression in the bilaterally symmetric HSN neurons (HSNL and HSNR) as well as glia-like cells in the worm's head  \citep{ringstad_fmrfamide_2008}. Optogenetic stimulation of the HSN neurons, which innervate the vulval musculature, evokes egg-laying behavior (L. Emtage and N. Ringstad, personal communication).

The two HSN neurons lie on top of one another when the worm is viewed laterally, so our system targets both neurons. We projected a thin stripe of blue light (473 nm, 5~mW~mm$^{-2}$) on the body of swimming P\textit{egl-6d::ChR2} transgenic worms. The long axis of the stripe was orthogonal to the worm centerline and spanned its diameter. The stripe width corresponded to 2\% of the anterior-posterior length of the worm centerline (that is, \textasciitilde20 $\mu$m of the \textasciitilde1-mm-long young adult worm). We used narrow stripes so that our illumination would be less probable to stimulate HSN when illuminating its process. We slowly moved the illumination stripe along the centerline of swimming worms while recording egg-laying events. Of 14 worms studied, we observed 13 egg-laying events, eight in which the stripe started at the head and five in which the stripe started at the tail. Egg-laying frequency sharply peaked when the center of the stripe coincided with the centerline coordinate of the HSN cell bodies, or 49.6\% of the total distance from the anterior to the posterior of the body with 3.2\% s.d. (Fig.~\ref{fig:colbert1}d and Supplementary Video 2). The width of this distribution suggests that the CoLBeRT system provides at least \textasciitilde30 $\mu$m of spatial resolution.


\subsection{Optogenetic manipulation of muscle cells}
In \textit{C. elegans}, forward movement is driven by motor neurons in the VNC, which coordinate the activity of 95 body wall muscle cells along the dorsal and ventral sides of the VNC \citep{von_stetina_motor_2006}. The circuit for worm locomotion is poorly understood in comparison to that of other undulatory animals such as the leech and lamprey \citep{marder_principles_1996, bryden_neural_2008, karbowski_systems_2008}. Because this circuit probably operates normally only during normal movement, technology such as the CoLBeRT system is necessary to dissect cellular activity in unrestrained animals.

We used the CoLBeRT system to suppress muscle activity in a region of the body in P\textit{myo-$3$ ::Halo/NpHR::CFP} transgenic worms (Fig.~\ref{fig:colbert2} and Supplementary Video 3). This perturbation of undulatory dynamics can be shown graphically using a red-blue color map to represent the curvature of the body centerline in nondimensional units (that is, the curvature calculated at each point along the centerline, $\kappa$, multiplied by worm length, $L$) as a function of time and fractional distance along the centerline, $s$, from head ($s = 0$) to tail ($s = 1$) (Fig.~\ref{fig:colbert2}a). Notably, hyperpolarizing muscle cells in one segment had no effect on undulatory dynamics anterior to the segment, but lowered the amplitude of the bending wave posterior to the illuminated segment (Fig.~\ref{fig:colbert2}b). Representative data from one of five worms that we studied are shown in Figure \ref{fig:colbert2}. Thus, the bending of posterior body segments seems coupled to the bending of anterior body segments. One possibility is that muscle activity in posterior segments is directly promoted by muscle activity in anterior segments, perhaps by gap junction coupling between muscle cells \citep{liu_low_2006}. Another possibility is that the motor circuit contains a proprioceptive mechanism that makes the activity of posterior segments directly sensitive to the bending of anterior segments.

\begin{figure} 
\includegraphics[width=\textwidth]{figures/colbert2}
\caption[Optogenetic inactivation of muscle cells.]{Optogenetic inactivation of muscle cells. (\textbf{a}) Kymograph of time-varying body curvature along the centerline of a P\textit{myo-$3$::Halo/NpHR::CFP} transgenic worm. Between 0 s and 4 s, the worm was illuminated with green light (10~mW~mm$^{-2}$) in a region spanning the worm diameter and between 0.38 and 0.6 of the fractional distance along the centerline. (\textbf{b}) For the kymograph in \textbf{a}, time-varying curvature at two points along the worm centerline, both anterior (top) and posterior (bottom) to the illuminated region. \label{fig:colbert2}}
\end{figure}


\subsection{Optogenetic manipulation of cholinergic motor neurons}
The cell bodies of motor neurons in \textit{C. elegans} are distributed along the VNC \citep{von_stetina_motor_2006,wicks_dynamic_1996}. Ventral muscles are innervated by the cholinergic VA, VB and VC motor neurons and GABAergic VD motor neurons. Dorsal muscles are innervated by the cholinergic DA, DB and AS motor neurons and GABAergic DD motor neurons\citep{white_structure_1976,chen_wiring_2006}. A current model is that VA and DA drive muscle contraction during backward locomotion, VB and DB drive muscle contraction during forward locomotion and VD and DD motor neurons drive muscle relaxation during both forward and backward locomotion \citep{wicks_dynamic_1996,von_stetina_motor_2006,haspel_motoneurons_2010}. A repeating motif of synaptic connectivity between the motor neurons runs along the worm body and allows for contralateral inhibition \citep{von_stetina_motor_2006}. During forward locomotion, for example, the DB (or VB) motor neurons can simultaneously excite a dorsal (or ventral) muscle cell while exciting the GABAergic VD (or DD) motor neurons that inhibit the opposing ventral (or dorsal) muscle cell \citep{white_structure_1976,chen_wiring_2006}. However, how this network drives the rhythmic undulatory wave is poorly understood.

We analyzed the contributions of cholinergic neurons to forward locomotion using transgenic worms expressing Halo/NpHR in all cholinergic neurons under the control of the \textit{unc-17} promoter \citep{roghani_molecular_1994}. In P\textit{unc-17::Halo/NpHR::CFP} transgenic worms, illumination of a short segment of the VNC suppressed propagation of the undulatory wave to the entire region posterior to the illuminated segment without affecting the undulatory wave anterior to the illuminated segment (Fig.~\ref{fig:colbert3}a,b and Supplementary Video 4). Representative data from one of five worms that we studied are shown in Figure \ref{fig:colbert3}a,b. This suggests that the activity of posterior VB and DB neurons is coupled to the activity of anterior VB and DB neurons, consistent with a wave of neuronal excitation that propagates from head to tail during forward movement.

\begin{figure} 
\includegraphics[width=\textwidth]{figures/colbert3}
\caption[Inhibition of motor neurons. ]{ Inhibition of motor neurons.  (\textbf{a}) Schematic of cholinergic DB and VB motor neurons. Anterior, to left; dorsal, to top. Kymograph of time-varying body curvature along the centerline of a P\textit{unc-17::Halo/NpHR::CFP} transgenic worm illuminated by a stripe of green light (10~mW~mm$^{-2}$) along its VNC between $t$ = 0 s and 1.6 s. In the dorsal-ventral direction, the stripe width was equal to 50\% of the worm diameter and centered on the ventral boundary. In the anterior-posterior direction, the stripe length was between 0.14 and 0.28 of the fractional distance along the body. (\textbf{b}) For the kymograph in a, time-varying curvature at two points along the worm centerline, both anterior (top) and posterior (bottom) to the illuminated region. (\textbf{c}) Video sequence of worm illuminated by a long stripe of green light (10~mW~mm$^{-2}$) spanning the VNC between $t$ = 0 s and 1.8 s. Scale bar, ~100 $\mu$m. (\textbf{d}) Bending wave speed of a swimming worm illuminated by a long stripe of green light (10~mW~mm$^{-2}$) lasting 1.8 s and spanning the VNC (top) and dorsal nerve cord (bottom).\label{fig:colbert3}}
\end{figure}

Using the CoLBeRT system, we can also specifically illuminate either the dorsal nerve cord or the VNC (Supplementary Video 5). The VNC contains the cell bodies of the cholinergic motor neurons, whereas the dorsal nerve cord contains only nerve processes. Illuminating the entire VNC was particularly effective in hyperpolarizing the cholinergic motor neurons of P\textit{unc-17::Halo/NpHR::CFP} worms, inducing paralysis. Illuminating the entire dorsal nerve cord, however, produced only a small ( \textasciitilde15\%) drop in the speed of wave propagation (Fig.~\ref{fig:colbert3}c,d). The asymmetric effect of illuminating the ventral and dorsal nerve cords is probably due to the higher density of optogenetic protein in the cell bodies.

To our surprise, the paralysis evoked by illuminating the VNC can occur without allowing relaxation of the worm body. In this instance, as long as the entire cholinergic network within the VNC was deactivated, the worm retained the posture it had immediately before illumination (Fig.~\ref{fig:colbert3}c). When the muscle cells of a swimming worm were hyperpolarized, on the other hand, the body straightened (Supplementary Video 1). This observation suggests that muscle cells can remain in contracted or relaxed states without requiring continuous cholinergic input.


\subsection{Optogenetic manipulation of single touch receptor types}
Next, we applied the CoLBeRT system to the touch receptor system in \textit{C. elegans}. Six cells are specialized for sensing gentle touch in \textit{C. elegans}: the left and right anterior lateral microtubule cells (ALML and ALMR, respectively); the left and right posterior lateral microtubule cells (PLML and PLMR, respectively); the anterior ventral microtubule cell (AVM); and the posterior ventral microtubule cell (PVM) \citep{chalfie_neural_1985}. Gently touching the worm near its anterior stimulates reversal movement dependent on ALML, ALMR and AVM. Gently touching the worm near its posterior stimulates forward movement dependent on PLML and PLMR. The role of PVM remains unclear.

Channelrhodopsin can be expressed in all six touch receptor cells using the \textit{mec-4} promoter. Illuminating the whole body of transgenic worms with blue light evokes reversal responses, presumably by simultaneously activating ALM, AVM and PLM1. With the spatial resolution afforded by the CoLBeRT system, we could individually activate the ALM, AVM and PLM cell types. The left and right lateral cells (ALML and ALMR; PLML and PLMR) lie on top of one another when the worm is viewed laterally. Illuminating the anterior end containing both the AVM and ALM neurons triggered reverse movement (Fig. \ref{fig:colbert4}a and Supplementary Video 6). Illuminating the posterior end containing the PLM neurons triggered forward movement (Fig. \ref{fig:colbert4}b and Supplementary Video 7). Representative data from one of five worms that we studied are shown in Figure \ref{fig:colbert4}a,b.


\begin{FPfigure} 
\includegraphics[width=\textwidth]{figures/colbert4}
\caption[Optogenetic analysis of mechanosensory neurons. ]{ Optogenetic analysis of mechanosensory neurons.  (\textbf{a})Top, schematic of anterior and posterior touch receptor cells. 
Anterior, to left; dorsal, to top. Kymographs (left) of time-varying curvature of centerline of worms expressing ChR2 in mechanosensory neurons (P\textit{mec-4::ChR2::GFP}) subjected to rectangles of blue light (5~mW~mm$^{-2}$) targeting different groups of touch receptor neurons. Plots of bending wave speed (right) indicate stimulus-evoked changes in direction or speed. AVM and ALM neurons are subjected to 1.5 s of stimulation. Given a coordinate system where $x$ specifies dorsal-ventral location (–1, dorsal boundary; 0, centerline; 1, ventral boundary) and $y$ defines fractional distance along the worm's centerline (0, head; 1, tail), the rectangle of illumination has corners ($x$,$y$) = ((-1.1,0),(1.1,0.46)). 
(\textbf{b}) PVM and PLM neurons are subjected to 2.5 s of stimulation with a rectangular illumination ($n$ = 5 worms, representative trace) with corners at ($x$,$y$) = ((-1.1,0.62),(1.1,0.99)). (\textbf{c}) ALM cell body is specifically stimulated by illuminating a small rectangle with corners at ($x$,$y$) = ((-0.3,0.38), (-0.9,0.46)). 
(\textbf{d}) AVM cell body is specifically stimulated by illuminating a small rectangle with corners at ($x$,$y$) = ((0.3,0.3),(0.9,0.38)).\label{fig:colbert4}}
\end{FPfigure}

Using the CoLBeRT system, we could also induce reversals by targeting just AVM or ALM with an illumination box (20 $\mu$m in the dorsal-ventral dimension; 30 $\mu$m in the anterior-posterior direction for a young adult worm) that was centered on each cell body (Fig.~\ref{fig:colbert4}c,d and Supplementary Videos 8 and 9). Representative data from one of fourteen worms that we studied are shown in Figure \ref{fig:colbert4}c,d. Using these illumination boxes, we could avoid illuminating the axon of the nontargeted neuron. These observations are consistent with earlier work showing that single touch receptor types are sufficient to drive behavioral responses \citep{chalfie_developmental_1981}.

To confirm that the CoLBeRT system can specifically target either AVM or ALM, we used transgenic worms expressing the photoconvertible fluorescent protein Kaede in the mechanosensory neurons \citep{ando_optical_2002}. Upon illumination by UV or violet light, Kaede converts from a green to a red fluorescent state. We used the CoLBeRT  system with 405-nm light to specifically illuminate either the AVM or ALM cell bodies for 60 s in freely moving P\textit{mec-4::Kaede} worms. We found that worms in which AVM or ALM had been targeted showed only detectable red fluorescence in AVM or ALM, respectively, whereas all mechanosensory neurons showed green fluorescence (Fig.~\ref{fig:colbert5}a,b). When targeting ALM, a transient segmentation error owing to an omega turn by the worm caused the system to illuminate PLM and PVM for ~1 s, producing slight photoconversion in those neurons (Fig.~\ref{fig:colbert5}b). By quantifying the ratio between the red and green fluorescence signals, we estimated that the nontargeted neurons were illuminated for less than \textasciitilde1 s (Methods).

\begin{figure} 
\includegraphics[width=\textwidth]{figures/colbert5}
\caption[Habituation of individual touch receptor neuronal types.]{ Habituation of individual touch receptor neuronal types. (\textbf{a,b}) Schematic showing anterior and posterior touch receptor neurons (top). Anterior, to left; dorsal, to top. A freely swimming worm expressing Kaede in touch receptor neurons was continuously tracked and illuminated with a small rectangle of 405~nm light (2~mW~mm$^{-2}$) centered on either AVM or ALM (as in Fig.~\ref{fig:colbert4}c,d) for 60 s. Red and green fluorescence images are shown. Scale bars, 100~$\mu$m. (\textbf{c–e}) Individual ALM and AVM neurons were repeatedly stimulated with blue light (5~mW~mm$^{-2}$) for 1.5 s every 60 s for \textasciitilde40 min, either alone (\textbf{c,d}) or interleaved within each experiment (\textbf{e}; ALM, 30 s; AVM, 30 s; ALM, 30 s; and so on). Fractional response to stimulus of each neuronal type was fit to an exponential, $a + b \exp(–t/\tau)$, using maximum likelihood estimator. Time constant for habituation, $\tau$, was extracted from each fit. Error bars, s.e.m. Fractional response of ALM when stimulated alone (\textbf{c}; $n$ = 7 worms). Fractional response of AVM when stimulated alone (\textbf{d}; $n$ = 8 worms). Fractional response of ALM (left) and AVM (right) during interleaved stimulation of both (\textbf{e} ; $n$ = 7 worms).\label{fig:colbert5}}
\end{figure}

It has been shown that the mechanosensory circuit habituates to repetitive optogenetic stimulation \citep{nagel_light_2005}. We used the CoLBeRT system to quantify the rate of AVM and ALM habituation over 40 min by repeatedly stimulating either AVM or ALM every 60 s. We observed comparable rates of habituation for both ALM and AVM (Fig.~\ref{fig:colbert5}c,d). Others have studied loci for habituation in the mechanosensory circuit by laser-killing touch receptor cells and/or downstream neurons and quantifying rates of habituation to gentle touch \citep{wyart_optogenetic_2009}. If habituation partly occurs at interneurons that are downstream of both ALM and AVM, then we might expect cross-habituation of the AVM response to repeated ALM stimulation, and vice-versa. Cross-habituation may also be mediated by electrical gap junction between AVM and ALM \citep{white_structure_1976}. To test whether cross-habituation occurs, we subjected a worm to interleaved AVM and ALM stimulation every 30 s, such that each neuron type was stimulated every 60 s. We found that the rates of habituation to both AVM and ALM stimulation were indeed more rapid with interleaved stimulation than with individual stimulation. This effect was particularly marked in the case of AVM stimulation (Fig.~\ref{fig:colbert5}e).

\section{Discussion}
At present, the spatial resolution of CoLBeRT is \textasciitilde{30} $\mu$m when tracking a swimming worm. The system has better resolution when tracking the slower movements of a crawling worm but is ultimately limited to \textasciitilde5~$\mu$m resolution owing to the pixel resolution of the DMD. In principle, higher spatial resolution could be reached by tracking a specific region of the worm (for example, the nerve ring) at higher magnification. This modification to CoLBeRT would require a different approach to image analysis and targeting, for example, analysis of cell body fluorescence instead of analysis of the posture of the whole worm.

CoLBeRT may be adapted to the opto\-gen\-etic analysis of other genetic\-ally tract\-able, trans\-parent animals such as the \textit{Drosophila melanogaster} or \textit{D. rerio} larvae. A simplified version of CoLBeRT may also be used to facilitate optogenetic illumination in other settings, for example, studies of mammalian brain slices or exposed brain surfaces. Variants of CoLBeRT using its capacity for rapid closed-loop feedback may be used to trigger optogenetic stimulation based on simultaneous recordings of neural activity in addition to animal posture.

CoLBeRT is a flexible and easy-to-use platform for designing and projecting arbitrary spatiotemporal patterns of illumination with closed-loop sensitivity to the real-time behavior of the worm.

\section{Methods}
\subsection{Strains}
We cultivated transgenic worms in the dark at 20 \textdegree C on nematode growth medium (NGM) plates with OP50 bacteria with all-trans retinal. We made OP50-retinal plates by seeding 6-cm NGM plates with 250 $\mu$l of a suspension of OP50 bacteria in LB, to which we added 1 $\mu$l of 100~mM retinal in ethanol immediately before seeding. Plates were stored in the dark and all worms were handled in the dark or under red light.


Strain FQ10 (P\textit{egl-6::ChR2::YFP}) was a gift of Nials Ringstad. Strain QH3341 (vdEx128(P\textit{mec-4::Kaede})) was a gift of Brett Neu\-mann and Massimo Hill\-iard. Strains ZX444 (\textit{lin-15}(n765ts); zxEx29 (P\textit{myo-3::NpHR::ECFP}; \textit{lin-15}+)) and ZX422 (\textit{lin-15}(n765ts); zxEx33 (P\textit{unc-17::NpHR::ECFP}; \textit{lin-15}+)) were gifts of Alex\-ander Gotts\-chalk. Strain P\textit{myo-3::Halo::CFP} used in our experiments was generated by integrating the trans\-gene in ZX444 by cobalt-60 irradiation and outcrossing the resulting strain three times to the wild-type N2 strain. Strain P\textit{unc-17::Halo::CFP} used in our experiments was generated by Mei Zhen by irradiating ZX422 using UV radiation and outcrossing twice to the wild-type N2 strain. The P\textit{mec-4::ChR2} strain (QW309) was generated by injection of P\textit{mec-4::ChR2::YFP} plasmid at 100~ng~$\mu$l$^{-1}$ into \textit{lin-15}(n765ts) worms along with the \textit{lin-15} rescuing plasmid (pL15 EK) at 50~ng~$\mu$l$^{-1}$; the extrachromosomal array was integrated using gamma irradiation and outcrossed four times to wild-type N2.

\subsection{Microscopy}
The setup is built around a Nikon Eclipse TE2000-U inverted microscope. We carried out dark-field imaging using annular illumination of the specimen through a Ph3 phase ring. A filter transmitting red light (Hoya) was mounted to the microscope illumination optical pathway to minimize inadvertent activation of ChR2 or Halo/NpHR owing to dark-field illumination.

We imaged worms using a 10×, numerical aperture (NA) 0.45 Plan Apo objective. We used a custom optical system composed of two camera lenses (Nikon) to reduce the size of the image on the camera by a factor of 3.5. This allowed us to capture almost all of the 2.5-mm-diameter field of view on the camera sensor. We used a PhotonFocus MV2-D1280-640CL camera and BitFlow Karbon PCI Express ×8 10-tap Full Camera Link frame grabber to capture images.

The microscope stage was controlled by a Ludl BioPrecision2 XY motorized stage and MAC 6000 stage-controller. During data acquisition, computer software kept the worm centered in the field of view via an automated feedback loop.

\subsection{Optics and illumination}
To stimulate ChR2 we used a DPSS laser (LP473-100, 473-nm wavelength, 100-mW maximum power, LaserShowParts). Similarly, to stimulate Halo/NpHR we used a DPSS laser (LP532-200, 532-nm wavelength, 200-mW maximum power, LaserShowParts). To photoconvert Kaede, we used a DPSS laser (EL-100B, 405-nm wavelength, 100-mW maximum power, Laserwold). The beams from the 473-nm and 532-nm lasers were aligned to a common path by a dichroic beamsplitter. The beam from the 405-nm laser was aligned to the common path with a retractable mirror. For each experiment, however, only one of the three lasers was used. The laser beam was expanded using a telescope composed of two plano-convex lenses and incident onto a 1,024 × 768 pixel digital micromirror device (Texas Instruments DLP, Discovery 4000 BD VIS 0.55-inch XGA, Digital Light Innovations) attached to a mirror mount. Using a series of mirrors, the laser was aligned such that the reflected beam for the 'on' state of the DMD was centered on the optical axis of the illumination pathway.

The plane of the DMD was imaged onto the sample via the epifluorescence illumination pathway of the microscope using an optical system composed of two achromatic doublet lenses. We used a dichroic filter, FF580-FDi01-25x36 (Semrock), to reflect 405-nm, 473-nm or 532-nm laser light onto the sample while passing wavelengths used for dark-field illumination ($\lambda$ > 600 nm). We used an emission filter, BLP01-594R-25 (Semrock), to prevent stray laser reflections from reaching the camera. The dichroic and emission filters were mounted in a custom filter cube in the microscope filter turret.
